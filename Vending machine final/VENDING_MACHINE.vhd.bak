-- FileName: lcd_example.vhd
-- Design Software: Quartus II 32-bit Version 11.1 Build 173 SJ Full Version
-- Carlos Pérez Araujo Instituto tecnologico de estudios superiores de monterrey

LIBRARY IEEE;
USE IEEE.STD_LOGIC_1164.ALL;
USE IEEE.NUMERIC_STD.ALL;

ENTITY VENDING_MACHINE IS
	PORT (
	      CLK : IN STD_LOGIC; 
			--LCD_EXAMPLE
			RW, RS, E : OUT STD_LOGIC; 
		   LCD_DATA :  OUT STD_LOGIC_VECTOR(7 DOWNTO 0);
		   --KEYPAD
			ROW : IN  STD_LOGIC_VECTOR(0 TO 3);    --KEYPAD'S ROW INPUTS
			COL : OUT STD_LOGIC_VECTOR(0 TO 3);    --KEYPAD'S COLUMNS OUTPUTS
			N   : OUT STD_LOGIC_VECTOR(3 DOWNTO 0); --LED'S OUTPUTS BCD
			key_availablemainout : out std_logic
	     );
END VENDING_MACHINE;


ARCHITECTURE STRUCTURAL OF VENDING_MACHINE IS


--SEÑALES INTERNAS DE SALIDA AL LCD
SIGNAL RS_MAIN,RW_MAIN,E_MAIN : STD_LOGIC := '0';
SIGNAL LCD_DATA_MAIN : STD_LOGIC_VECTOR(7 DOWNTO 0):= "00000000";

--CLK 1 KHZ KEYPAD MODULO
SIGNAL  KEY_AVAILABLEMAIN: STD_LOGIC := '0';

SIGNAL CLOCK100HZ, CLOCK1HZ : STD_LOGIC := '0';

SIGNAL QD : STD_LOGIC := '0';


--SEÑALES INTERNAS  PARA COLUMNAS Y RENGLONES DEL JEYPD
SIGNAL ROW_MAIN,COL_MAIN : STD_LOGIC_VECTOR(0 TO 3):= "0000";
SIGNAL KEY_MAIN : STD_LOGIC_VECTOR (3 DOWNTO 0);


SIGNAL LCD_ENABLE_EXAMPLE : STD_LOGIC := '0';

		COMPONENT CLK1KHZ IS
		PORT (
			MCLK : IN STD_LOGIC;
			CLKOUT : OUT STD_LOGIC
		);
		END COMPONENT;


		COMPONENT KEYPAD IS
		PORT (
			CLK : IN  STD_LOGIC;
			ROW : IN  STD_LOGIC_VECTOR(0 TO 3);
			COL : OUT STD_LOGIC_VECTOR(0 TO 3);
			KEY : OUT STD_LOGIC_VECTOR(3 DOWNTO 0);
			KEY_AVAILABLE : OUT STD_LOGIC
		);
		END COMPONENT;
			


		COMPONENT LCD_EXAMPLE IS     
		PORT (
				CLK : IN STD_LOGIC; 
				RW, RS, E : OUT STD_LOGIC; 
				LCD_DATA : OUT STD_LOGIC_VECTOR(7 DOWNTO 0);
				KEY : IN STD_LOGIC_VECTOR( 3 DOWNTO 0);
				KEY_AVAILABLE : IN STD_LOGIC
				);			
      END COMPONENT;

COMPONENT DEBOUNCE IS
	PORT (
		CLK   : IN STD_LOGIC;
		DIN   : IN STD_LOGIC;
		QOUT  : OUT STD_LOGIC
	);
END COMPONENT;
		
COMPONENT CLK100HZ IS
	PORT (
		MCLK : IN STD_LOGIC;
		CLKOUT : OUT STD_LOGIC
	);
END COMPONENT;

BEGIN



--LCD_EXAMPLE SALIDAS FISICAS

RW <= RW_MAIN;
RS<= RS_MAIN;
E <= E_MAIN;  
LCD_DATA <= LCD_DATA_MAIN;

--KEYPAD SALIDAS FISICAS

COL <=COL_MAIN;
N <=KEY_MAIN;

key_availablemainout<= QD;


COMPONENT_CLK100HZ : CLK100HZ PORT MAP (CLK, CLOCK100HZ);

COMPONENT_DEBOUNCE : DEBOUNCE PORT MAP (CLOCK100HZ,key_availablemain,QD);

COMPONENT_LCD_EXAMPLE: LCD_EXAMPLE PORT MAP ( CLK => CLK,
															 RW => RW_MAIN,   -- SALIDAS EXTERNAS  
															 RS => RS_MAIN,   --SALIDAS EXTERNAS
															 E => E_MAIN,     --SALIDAS EXTERNAS
															 LCD_DATA => LCD_DATA_MAIN,  --SALIDAS EXTERNAS
															 KEY => KEY_MAIN,  --SEÑAL PARA KEYPAD
															 KEY_AVAILABLE => KEY_AVAILABLEMAIN  --SEÑAL PARA KEYPAD 
															 );

COMPONENT_CLK1KHZ :   CLK1KHZ 		PORT MAP( MCLK => CLK,
															 CLKOUT =>CLOCK1KHZ
														  );
												  
												  

COMPONENT_KEYPAD: KEYPAD            PORT MAP (
															CLK => CLOCK1KHZ,
															ROW => ROW,
															COL => COL_MAIN,
															KEY => KEY_MAIN,
															KEY_AVAILABLE=> KEY_AVAILABLEMAIN
												 );
															
															 
														

END STRUCTURAL;